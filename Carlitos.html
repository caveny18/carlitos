<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carlitos Home | Mi Progreso</title>

  <!-- Tailwind para utilidades rápidas (puedes quitarlo si ya lo tienes) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FUENTE -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #f7fbfc;
      --card: #ffffff;
      --muted: #6b7280;
      --accent-1: #6366f1;
      --accent-2: #a855f7;
      --glass: rgba(255,255,255,0.7);
      --round: 14px;
    }

    html,body { height:100%; }
    body{
      font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(180deg, #f8fbff 0%, var(--bg) 100%);
      margin:0;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      color:#0f172a;
      padding-bottom: 110px;
    }

    /* Layout */
    .container { max-width: 980px; margin: 28px auto; padding: 0 16px; }
    header.app-header {
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:16px;
    }
    .brand-title { font-weight:800; font-size:28px; background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* Cards */
    .card {
      background:var(--card);
      border-radius: var(--round);
      border: 1px solid rgba(7,22,41,0.06);
      box-shadow: 0 12px 30px rgba(8,20,34,0.04);
      padding: 18px;
      transition: transform 260ms cubic-bezier(.2,.9,.3,1), box-shadow 260ms;
    }
    .card:hover { transform: translateY(-6px); box-shadow: 0 26px 60px rgba(7,22,41,0.08); }

    .muted { color: var(--muted); font-size: 14px; }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(90deg,var(--accent-1),var(--accent-2));
      color: white;
      padding: 8px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:700;
      box-shadow: 0 12px 36px rgba(8,20,34,0.06);
      transition: transform 160ms ease, filter 160ms;
      border: none;
    }
    .btn-primary:hover { transform: translateY(-2px); filter:brightness(1.03); }
    .btn-ghost {
      background: transparent;
      border: 1px solid rgba(7,22,41,0.06);
      padding: 8px 12px;
      border-radius: 12px;
      color: var(--muted);
      cursor:pointer;
      font-weight:600;
    }

    /* XP bar */
    .xp-bar { width:100%; height:14px; background: linear-gradient(90deg,#eef7f6,#f5fbfa); border-radius:999px; overflow:hidden; border:1px solid rgba(3,105,161,0.03); }
    .xp-fill { height:100%; width:0%; background: linear-gradient(90deg,#10b981,#0369a1); transition: width 700ms cubic-bezier(.2,.9,.3,1); }

    /* Tutor icon */
    #tutorIcon { width:72px; height:72px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:700; overflow:hidden; box-shadow: 0 10px 30px rgba(3,105,161,0.06); }

    /* Mentor tour UI */
    .tour-overlay {
      position: fixed;
      inset: 0;
      z-index: 10050;
      pointer-events: none;
      transition: background 380ms ease;
      --spot-x: 120px;
      --spot-y: 120px;
      --spot-r: 80px;
      background:
        radial-gradient(circle at var(--spot-x) var(--spot-y), rgba(0,0,0,0) calc(var(--spot-r) - 8px), rgba(0,0,0,0.55) calc(var(--spot-r) - 8px + 10px));
      backdrop-filter: blur(1px) saturate(1.03);
    }

    .mentor-image-tour {
      width: 120px; height:120px; border-radius: 18px; overflow: hidden;
      display:flex; align-items:center; justify-content:center;
      border: 3px solid rgba(3,105,161,0.08);
      position: fixed; z-index: 10090;
      transition: transform 700ms cubic-bezier(.22,.9,.32,1), left 700ms cubic-bezier(.22,.9,.32,1), top 700ms cubic-bezier(.22,.9,.32,1), opacity 250ms;
      box-shadow: 0 26px 60px rgba(6,8,15,0.08);
      background-color: var(--card);
      pointer-events: none;
      animation: floaty 3.2s ease-in-out infinite;
    }
    @keyframes floaty { 0% { transform: translateY(0);} 50% { transform: translateY(-8px);} 100% { transform: translateY(0);} }

    .mentor-bubble {
      position: fixed;
      z-index: 10095;
      max-width: 460px;
      background: linear-gradient(180deg,#ffffff,#f8fbfc);
      border:1px solid rgba(3,105,161,0.06);
      color: var(--text);
      padding: 14px 16px;
      border-radius: 14px;
      box-shadow: 0 24px 60px rgba(7,22,41,0.09);
      transition: left 420ms cubic-bezier(.22,.9,.32,1), top 420ms cubic-bezier(.22,.9,.32,1), transform 260ms;
      font-size: 14px;
      pointer-events: auto;
      opacity: 0; transform: translateY(8px) scale(.98);
    }
    .mentor-bubble.show { opacity: 1; transform: translateY(0) scale(1); }
    .mentor-bubble strong { display:block; color:var(--accent-1); margin-bottom:6px; font-weight:800; }
    .mentor-bubble .bubble-text { min-height:42px; color:#0f172a; line-height:1.3; }

    .tour-highlight {
      position: relative;
      z-index: 10080;
      box-shadow: 0 0 0 12px rgba(3,105,161,0.04), 0 20px 40px rgba(7,22,41,0.06);
      border-radius: 0.9rem;
      transition: box-shadow 260ms, transform 260ms;
      transform-origin: center;
      animation: pulseHighlight 1.6s infinite;
    }
    @keyframes pulseHighlight {
      0% { box-shadow: 0 0 0 0 rgba(3,105,161,0.06); }
      50% { box-shadow: 0 0 0 8px rgba(3,105,161,0.02); }
      100% { box-shadow: 0 0 0 0 rgba(3,105,161,0.06); }
    }

    /* RESPONSIVE tweaks */
    @media (max-width: 900px) {
      .mentor-image-tour { width: 96px; height:96px; border-radius:12px; }
      .mentor-bubble { max-width: 320px; padding: 12px; font-size:13px; }
      .card { padding: 14px; }
    }
    @media (max-width: 640px) {
      body { padding-bottom: 140px; }
      .mentor-image-tour { width: 84px; height:84px; }
      .mentor-bubble { left: 10px !important; right: 10px !important; top: auto !important; bottom: 18% !important; transform: none !important; max-width: calc(100% - 40px); }
      .tour-overlay { background: rgba(0,0,0,0.75) !important; backdrop-filter: none !important; }
    }

    /* bottom nav */
    #bottom-nav {
      height:78px;
      border-top: 1px solid rgba(7,22,41,0.06);
      background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(250,252,253,0.98));
      box-shadow: 0 -8px 30px rgba(7,22,41,0.03);
      position: fixed; left:0; right:0; bottom:0; z-index:60;
    }
    #bottom-nav .nav-item { display:inline-flex; flex-direction:column; align-items:center; justify-content:center; padding:10px; font-size:12px; color:var(--muted); }

  </style>
</head>

<body>
  <div class="container">
    <header class="app-header">
      <div style="display:flex; gap:12px; align-items:center;">
        <h1 class="brand-title">Carlitos Home</h1>
        <p class="muted hidden sm:block">Tu viaje financiero — aprende, registra y crece</p>
      </div>
      <div style="display:flex; gap:10px; align-items:center;">
        <button id="repeat-tour-btn" class="btn-ghost" title="Repetir Tour Guiado">🎓 Repetir Tour</button>
        <button id="signout-btn" class="btn-ghost" title="Cerrar sesión">Salir</button>
      </div>
    </header>

    <main class="space-y-6">
      <!-- Profile + XP -->
      <section id="progress-card" class="card rounded-2xl p-6 sm:p-8 space-y-5">
        <div class="flex flex-col sm:flex-row items-center justify-between border-b pb-4 border-gray-100">
          <div class="flex items-center space-x-4">
            <div id="user-avatar" class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-500 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-xl">
              <span id="name-initial">C</span>
            </div>
            <div>
              <p class="text-2xl font-bold" id="user-name-display">Usuario</p>
              <p class="text-sm font-semibold muted" id="user-role-display">Aprendiz</p>
            </div>
          </div>

          <div class="flex items-center space-x-3 mt-4 sm:mt-0 bg-white px-4 py-2 rounded-full border border-gray-100">
            <span class="text-xl" style="color: #f59e0b">💰</span>
            <div class="text-right">
              <p class="text-xs text-yellow-500 font-medium uppercase">Mi CarlitosCoin</p>
              <p class="text-xl font-bold" id="user-coins">0</p>
            </div>
            <div class="ml-4">
              <button id="coins-details" class="btn-ghost">Ver más</button>
            </div>
          </div>
        </div>

        <div>
          <div class="flex justify-between items-end mb-2">
            <p class="text-lg font-bold" id="user-level-title">Nivel: Novato</p>
            <p class="text-sm muted">XP: <span id="user-xp-current">0</span>/<span id="user-xp-next">100</span></p>
          </div>
          <div class="xp-bar">
            <div id="xp-bar-fill" class="xp-fill" style="width:0%"></div>
          </div>
          <p class="text-xs muted mt-2 text-center" id="next-level-message">Sigue completando misiones para alcanzar el siguiente nivel.</p>
        </div>
      </section>

      <!-- Tools -->
      <section id="tools-section" class="card rounded-2xl p-6 sm:p-8">
        <h2 class="text-2xl font-bold mb-5">Mi Caja de Herramientas</h2>
        <div id="tool-list" class="space-y-3"></div>
        <p class="text-xs muted mt-4 text-center">Las herramientas se irán desbloqueando conforme avances.</p>
      </section>

      <!-- Goals -->
      <section id="goals-section" class="card rounded-2xl p-6 sm:p-8">
        <h2 class="text-2xl font-bold mb-5">Tus Metas Financieras</h2>
        <div id="user-goals-summary" class="muted space-y-3"></div>
        <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
          <p class="text-xs">Gestiona tus metas desde el Dashboard.</p>
          <div class="flex gap-3">
            <button id="add-goal-btn" class="btn-primary">Agregar nueva meta</button>
            <button id="view-dashboard-btn" class="btn-ghost">Ir al Dashboard</button>
          </div>
        </div>
      </section>

      <!-- Mentor -->
      <section id="mentor-section" class="card rounded-2xl p-6 sm:p-8">
        <h2 class="text-2xl font-bold mb-5">Tu Carlitos Mentor:</h2>

        <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-6 bg-white p-4 rounded-xl border border-gray-100">
          <div class="w-20 h-20 flex-shrink-0">
            <div id="tutor-icon-container" style="width:100%; height:100%; border-radius:999px; overflow:hidden; display:flex; align-items:center; justify-content:center; font-size:28px; background:linear-gradient(90deg,var(--accent-1),var(--accent-2)); color:white;">
              <!-- imagen de tutor -->
              <span id="tutor-icon">🧑‍🏫</span>
            </div>
          </div>

          <div class="text-center sm:text-left">
            <p id="tutor-role-display" class="tutor-role font-semibold text-lg">El Mentor</p>
            <p id="tutor-description" class="tutor-desc muted">Te acompaño en cada paso.</p>
            <div class="pt-4 mt-4 border-t border-gray-100">
              <p class="text-lg font-semibold">Próxima Misión:</p>
              <p class="text-purple-500 font-medium" id="first-mission-text">Completa tu primer registro</p>
            </div>
          </div>
        </div>
      </section>

    </main>

    <div class="text-center pt-6 pb-20">
      <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full">Reiniciar Onboarding (Borrar Perfil)</button>
    </div>
  </div>

  <!-- Bottom nav -->
<nav id="bottom-nav" class="nav-menu fixed bottom-0 left-0 right-0 bg-white border-t border-gray-100 z-40">
    <div class="flex justify-around max-w-2xl mx-auto py-2">
      <a href="./dashboard.html" class="nav-item text-center">
        <div class="nav-item inline-flex flex-col items-center muted">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 10.5h19.5m-4.5 4.5h-10.5m10.5 0a1.5 1.5 0 0 1 1.5 1.5v3.75a1.5 1.5 0 0 1-1.5 1.5h-10.5a1.5 1.5 0 0 1-1.5-1.5V16.5m1.5-6.042V4.5a1.5 1.5 0 0 1 1.5-1.5h7.5" /></svg>
          <span class="text-xs">Dashboard</span>
        </div>
      </a>
      <a href="./Aprender.html" class="nav-item text-center">
        <div class="inline-flex flex-col items-center muted">
          <svg class="w-6 h6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21.5L4 17.5V7.5L12 3.5L20 7.5V17.5L12 21.5Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12L20 7.5M12 12V21.5M12 12L4 7.5M4 17.5L12 12M20 17.5L12 12" /></svg>
          <span class="text-xs">Aprender</span>
        </div>
      </a>
      <a href="./Microaprendizaje.html" class="nav-item text-center">
        <div class="inline-flex flex-col items-center muted">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="m15 10.5 4.793-4.793a1 1 0 0 0 0-1.414l-2.06-2.06a1 1 0 0 0-1.414 0L12 7.086 8.707 3.793a1 1 0 0 0-1.414 0l-2.06 2.06a1 1 0 0 0 0 1.414L9 10.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="text-xs">Micro</span>
        </div>
      </a>
      <a href="./Carlitos.html" class="nav-item active text-center">
        <div class="inline-flex flex-col items-center" style="color:var(--accent-1)">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="text-xs">Perfil</span>
        </div>
      </a>
    </div>
  </nav>

  <!-- TOUR overlay + mentor UI created by JS -->

  <!-- =========================
       SCRIPT: perfil + tour mejorado
       ========================= -->
  <script type="module">
    /* -----------------------------
       CONFIG & CONSTANTS
       ----------------------------- */
    const PROFILE_KEY = 'carlitos_profile_data';
    const TUTOR_IMG_VARIANTS = {
      'Mono': ['mononormal.png','mononormal.webp','iconomono.png'],
      'Ardilla': ['ardillanormal.png','iconoardilla.png'],
      'Condor': ['condornormal.png','iconocondor.png'],
      'Gata': ['gatanormal.png','iconogata.png'],
    };

    const LEVELS = [
      { name: "Novato", minXP: 0, maxXP: 100, title: "El Curioso" },
      { name: "Aprendiz", minXP: 100, maxXP: 350, title: "El Experimentador" },
      { name: "Estratega", minXP: 350, maxXP: 800, title: "El Analista" },
      { name: "Maestro", minXP: 800, maxXP: 1500, title: "El Optimizador" },
      { name: "Leyenda", minXP: 1500, maxXP: 99999, title: "El Inmortal" },
    ];

    const ALL_TOOLS = [
      { id: 'registro_gastos', name: 'Registro de Ingresos y Gastos', requiredLevel: 1 },
      { id: 'planificador_presupuesto', name: 'Planificador de Presupuesto (50/30/20)', requiredLevel: 2 },
      { id: 'simulador_inversiones', name: 'Simulador de Inversiones Básicas', requiredLevel: 3 },
      { id: 'control_deuda', name: 'Control de Deuda', requiredLevel: 4 },
    ];

    // DOM refs
    const DOM = {
      welcome: document.getElementById('welcome-message'),
      nameInitial: document.getElementById('name-initial'),
      userName: document.getElementById('user-name-display'),
      userRole: document.getElementById('user-role-display'),
      userCoins: document.getElementById('user-coins'),
      xpCurrent: document.getElementById('user-xp-current'),
      xpNext: document.getElementById('user-xp-next'),
      xpFill: document.getElementById('xp-bar-fill'),
      levelTitle: document.getElementById('user-level-title'),
      nextLevelMsg: document.getElementById('next-level-message'),
      toolList: document.getElementById('tool-list'),
      goalsSummary: document.getElementById('user-goals-summary'),
      addGoalBtn: document.getElementById('add-goal-btn'),
      viewDashboardBtn: document.getElementById('view-dashboard-btn'),
      coinsDetailsBtn: document.getElementById('coins-details'),
      tutorIcon: document.getElementById('tutor-icon-container'),
      tutorRoleDisplay: document.getElementById('tutor-role-display'),
      tutorDescriptionDisplay: document.getElementById('tutor-description'),
      tutorMission: document.getElementById('first-mission-text'),
      resetBtn: document.getElementById('reset-button'),
      repeatTourBtn: document.getElementById('repeat-tour-btn'),
      signoutBtn: document.getElementById('signout-btn'),
    };

    /* -----------------------------
       UTIL: normalize tutor key
       ----------------------------- */
    function normalizeTutorKey(raw) {
      if (!raw) return 'Mono';
      const s = raw.toString().toLowerCase();
      if (s.includes('condor') || s.includes('cóndor') || s.includes('inti')) return 'Condor';
      if (s.includes('ardilla') || s.includes('saison')) return 'Ardilla';
      if (s.includes('gata') || s.includes('leopardo') || s.includes('auri') || s.includes('gato')) return 'Gata';
      if (s.includes('mono') || s.includes('kantu')) return 'Mono';
      return 'Mono';
    }

    /* -----------------------------
       UTIL: load image with fallbacks (returns HTMLImageElement)
       ----------------------------- */
    function createImgWithFallbacks(variants = [], onReady) {
      const img = new Image();
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'cover';
      let i = 0;
      function tryNext() {
        if (i >= variants.length) { if (onReady) onReady(img); return; }
        const candidate = variants[i++];
        img.onerror = tryNext;
        img.onload = () => { if (onReady) onReady(img); };
        img.src = candidate.startsWith('http') || candidate.startsWith('/') ? candidate : (candidate);
      }
      tryNext();
      return img;
    }
    function getFirstValidImage(variantList) {
      return new Promise(resolve => createImgWithFallbacks(variantList, (el) => resolve(el)));
    }

    /* -----------------------------
       Progress util
       ----------------------------- */
    function calculateProgress(totalXp) {
      let currentLevel = LEVELS[0];
      let progressPercentage = 0;
      for (let i = 0; i < LEVELS.length; i++) {
        if (totalXp < LEVELS[i].maxXP) {
          currentLevel = LEVELS[i];
          const xpInLevel = totalXp - currentLevel.minXP;
          const levelRange = currentLevel.maxXP - currentLevel.minXP;
          progressPercentage = (xpInLevel / levelRange) * 100;
          return { level: currentLevel, progressPercentage, xpToNextLevel: currentLevel.maxXP, currentLevelXp: totalXp };
        }
      }
      const lastLevel = LEVELS[LEVELS.length - 1];
      return { level: lastLevel, progressPercentage: 100, xpToNextLevel: lastLevel.maxXP, currentLevelXp: totalXp };
    }

    /* -----------------------------
       RENDER helpers
       ----------------------------- */
    function renderToolList(level) {
      const container = DOM.toolList;
      container.innerHTML = '';
      const userLevelNumber = LEVELS.findIndex(l => l.name === level.name) + 1;
      ALL_TOOLS.forEach(tool => {
        const isUnlocked = tool.requiredLevel <= userLevelNumber;
        const div = document.createElement('div');
        div.className = `flex items-center justify-between p-3 rounded-lg transition ${isUnlocked ? 'bg-white' : 'bg-gray-50 opacity-70'}`;
        div.innerHTML = `
          <span class="${isUnlocked ? 'text-black' : 'text-gray-400'} flex items-center">
            ${isUnlocked ? '<span class="mr-3 text-xl" style="color:#10b981">✅</span>' : '<span class="mr-3 text-xl text-red-400">🔒</span>'}
            ${tool.name}
          </span>
          <span class="${isUnlocked ? 'text-indigo-600' : 'text-gray-400'} text-xs font-bold">Nivel ${tool.requiredLevel}</span>
        `;
        container.appendChild(div);
      });
    }

    function renderGoals(goals = []) {
      const container = DOM.goalsSummary;
      container.innerHTML = '';
      if (!goals || goals.length === 0) {
        container.innerHTML = `<p class="muted">Aún no tienes metas. Crea tu primera meta en el Dashboard.</p>`;
        return;
      }
      goals.forEach((g, idx) => {
        const current = Number(g.current || 0);
        const target = Number(g.target || 1);
        const pct = Math.min(100, Math.round((current / target) * 100));
        const goalDiv = document.createElement('div');
        goalDiv.className = 'p-3 bg-white rounded-lg border border-gray-50';
        goalDiv.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-black">${g.title || 'Meta #' + (idx+1)}</p>
              <p class="text-xs muted">${(current).toLocaleString('es-CL')} / ${(target).toLocaleString('es-CL')}</p>
            </div>
            <div class="text-xs text-pink-500 font-bold">${pct}%</div>
          </div>
          <div class="mt-2 w-full bg-gray-100 rounded-full h-3 overflow-hidden">
            <div style="width:${pct}%" class="h-3 bg-gradient-to-r from-pink-500 to-pink-300"></div>
          </div>
          <div class="mt-3 flex justify-end">
            <button class="btn-ghost view-meta-detail" data-index="${idx}">Ver detalle</button>
          </div>
        `;
        container.appendChild(goalDiv);
      });

      container.querySelectorAll('.view-meta-detail').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = btn.dataset.index;
          window.location.href = `dashboard.html?goal=${idx}`;
        });
      });
    }

    /* -----------------------------
       DISPLAY profile
       ----------------------------- */
    async function displayProfile(profile = {}) {
      profile.totalXP = Number(profile.totalXP || 0);
      profile.carlitosCoins = Number(profile.carlitosCoins || 0);
      profile.primaryGoal = profile.primaryGoal || 'tu objetivo';
      profile.goals = profile.goals || [];

      const prog = calculateProgress(profile.totalXP);
      document.getElementById('user-name-display').textContent = profile.name || 'Usuario';
      document.getElementById('name-initial').textContent = (profile.name || 'C')[0]?.toUpperCase() || 'C';
      document.getElementById('user-role-display').textContent = profile.role || '';
      document.getElementById('user-coins').textContent = profile.carlitosCoins.toLocaleString('es-CL');
      document.getElementById('user-xp-current').textContent = prog.currentLevelXp;
      document.getElementById('user-xp-next').textContent = prog.level.name === 'Leyenda' ? 'MAX' : prog.xpToNextLevel.toLocaleString('es-CL');
      document.getElementById('user-level-title').textContent = `${prog.level.name} (${prog.level.title})`;
      document.getElementById('xp-bar-fill').style.width = `${prog.progressPercentage}%`;
      document.getElementById('next-level-message').textContent = prog.level.name === 'Leyenda' ? '¡Has alcanzado el máximo dominio!' : `Te faltan ${prog.xpToNextLevel - prog.currentLevelXp} XP para ser ${LEVELS[Math.min(LEVELS.length-1, LEVELS.findIndex(l => l.name === prog.level.name) + 1)].name}.`;

      renderToolList(prog.level);
      renderGoals(profile.goals);

      // Tutor icon
      const rawAssigned = profile.assignedTutor || '';
      const tutorKey = normalizeTutorKey(rawAssigned);
      const variants = TUTOR_IMG_VARIANTS[tutorKey] || [];
      const tutorIconEl = document.getElementById('tutor-icon');
      tutorIconEl.innerHTML = ''; // clear
      // load first valid image (if any) — otherwise show emoji fallback
      const img = await getFirstValidImage(variants);
      if (img && img.src) {
        img.style.width = '100%'; img.style.height = '100%'; img.style.objectFit='cover';
        const container = document.getElementById('tutor-icon-container') || document.getElementById('tutor-icon');
        // if we have a container to append (tutorIcon is simple span), replace
        if (document.getElementById('tutor-icon-container')) {
          const c = document.getElementById('tutor-icon-container');
          c.innerHTML = ''; c.appendChild(img);
        } else {
          tutorIconEl.appendChild(img);
        }
      } else {
        // fallback emoji
        tutorIconEl.textContent = tutorKey === 'Ardilla' ? '🐿️' : tutorKey === 'Condor' ? '🦅' : tutorKey === 'Gata' ? '🐱' : '🐵';
      }

      // tutor text
      const TUTOR_DATA = {
        'Mono': { role: 'El Ilustrador', description: 'Alegre y cercano: te enseña con ejemplos y humor.', mission: (g)=>`Haz el reto de presupuesto de 5 minutos para avanzar en ${g}.`, color:'#10b981'},
        'Ardilla': { role: 'La Ardilla', description: 'Enérgica y práctica: rutinas rápidas de ahorro.', mission: (g)=>`Crea un plan semanal de ahorro para ${g}.`, color:'#f97316' },
        'Condor': { role: 'El Estratega', description: 'Analítico y visionario para metas largas.', mission: (g)=>`Analiza tu flujo de caja para ${g}.`, color:'#1e40af' },
        'Gata': { role: 'La Analítica', description: 'Precisa: te reta con datos y simulaciones.', mission: (g)=>`Simula un portafolio para ${g}.`, color:'#7c3aed'}
      };
      const tutorInfo = TUTOR_DATA[tutorKey] || TUTOR_DATA['Mono'];
      document.getElementById('tutor-role-display').textContent = tutorInfo.role;
      document.getElementById('tutor-description').textContent = tutorInfo.description;
      document.getElementById('first-mission-text').textContent = tutorInfo.mission(profile.primaryGoal || 'tu meta');

      profile.assignedTutor = rawAssigned || tutorKey;
      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }

    /* -----------------------------
       LOAD profile from localStorage (or fallback demo)
       ----------------------------- */
    async function loadProfile() {
      const raw = localStorage.getItem(PROFILE_KEY);
      if (raw) return JSON.parse(raw);
      // demo fallback
      const demo = {
        name: 'Carla',
        role: 'Aprendiz',
        totalXP: 65,
        carlitosCoins: 150,
        primaryGoal: 'Fondo de Emergencia',
        goals: [{ title: 'Fondo Emergencia', current: 12000, target: 50000 }],
        assignedTutor: 'Mono'
      };
      localStorage.setItem(PROFILE_KEY, JSON.stringify(demo));
      return demo;
    }

    /* -----------------------------
       TOUR: state + builders
       ----------------------------- */
    let tourState = { active:false, step:0, steps:[], overlayEl:null, mentorEl:null, bubbleEl:null, typingLock:false, typingTimer:null };

    function buildTourSteps(profile) {
      const tutorKey = normalizeTutorKey(profile.assignedTutor || '');
      return [
        { sel: '#progress-card', title: 'Bienvenida', text: `¡Hola ${profile.name || 'amigo'}! Soy tu mentor. Te guiaré por Carlitos Home para que aproveches todas las funciones.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#user-avatar', title: 'Tu perfil', text: `Aquí ves tu avatar, nombre y rol. Personaliza tu apodo en el Dashboard.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#coins-details', title: 'Tus CarlitosCoins', text: `Tus CarlitosCoins se obtienen por sesiones y retos. Úsalos en la tienda de recompensas.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#goals-section', title: 'Tus metas', text: `Aquí gestionas metas con barras de progreso. Pulsa "Ver detalle" para editar en el Dashboard.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#tools-section', title: 'Herramientas', text: `Estas son las herramientas desbloqueables: registro, planificador y simulador. Usa la práctica para ganar XP.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#mentor-section', title: 'Tu Mentor', text: `Aquí aparezco yo con mi descripción y mis misiones. ¡A completar retos!`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#bottom-nav', title: 'Menú inferior', text: `Usa el menú inferior para navegar: Dashboard, Aprender y Microaprendizaje.`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] },
        { sel: '#progress-card', title: 'Final', text: `¡Listo! Si quieres repetir el recorrido usa "Repetir Tour". ¡A aprender!`, imgVariantList: TUTOR_IMG_VARIANTS[tutorKey] || [] }
      ];
    }

    /* -----------------------------
       TOUR: UI creation + helpers
       ----------------------------- */
    function createTourUI(profile) {
      // remove previous
      const oldO = document.getElementById('tour-overlay'); if (oldO) oldO.remove();
      const oldM = document.getElementById('tour-mentor-image'); if (oldM) oldM.remove();
      const oldB = document.getElementById('tour-mentor-bubble'); if (oldB) oldB.remove();

      // overlay
      const overlay = document.createElement('div');
      overlay.className = 'tour-overlay';
      overlay.id = 'tour-overlay';
      document.body.appendChild(overlay);
      tourState.overlayEl = overlay;

      // mentor image
      const mentorImg = document.createElement('img');
      mentorImg.id = 'tour-mentor-image';
      mentorImg.className = 'mentor-image-tour';
      mentorImg.alt = 'Mentor';
      mentorImg.style.left = '16px';
      mentorImg.style.top = '120px';
      document.body.appendChild(mentorImg);
      tourState.mentorEl = mentorImg;

      // bubble
      const bubble = document.createElement('div');
      bubble.id = 'tour-mentor-bubble';
      bubble.className = 'mentor-bubble';
      bubble.style.left = '24px';
      bubble.style.top = '24px';
      bubble.innerHTML = `<div id="tour-bubble-content"><strong>Hola</strong><div class="bubble-text"></div></div>
        <div class="tour-controls" style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
          <button id="tour-skip" class="btn-ghost">Omitir</button>
          <button id="tour-prev" class="btn-ghost">Atrás</button>
          <button id="tour-next" class="btn-primary">Siguiente</button>
        </div>`;
      document.body.appendChild(bubble);
      tourState.bubbleEl = bubble;

      // controls
      bubble.querySelector('#tour-skip').onclick = () => endTour(true);
      bubble.querySelector('#tour-prev').onclick = () => { if (tourState.step > 0) { tourState.step--; showTourStep(); } };
      bubble.querySelector('#tour-next').onclick = () => {
        if (tourState.typingLock) { finishTypingNow(); return; }
        tourState.step++;
        if (tourState.step >= tourState.steps.length) return endTour();
        showTourStep();
      };
    }

    // compute spotlight for rect (rect is DOMRect)
    function setSpotlightForRect(rect) {
      const overlay = tourState.overlayEl;
      if (!overlay) return;

      const isNav = rect.top > (window.innerHeight - 160) || rect.id === 'bottom-nav' || rect.top > window.innerHeight - 160;
      if (isNav) {
        const top = Math.max(0, rect.top - 12);
        const bottom = Math.min(window.innerHeight, rect.bottom + 12);
        overlay.style.background = `linear-gradient(to bottom,
          rgba(0,0,0,0.55) 0%,
          rgba(0,0,0,0.55) ${top}px,
          rgba(0,0,0,0) ${top}px,
          rgba(0,0,0,0) ${bottom}px,
          rgba(0,0,0,0.55) ${bottom}px,
          rgba(0,0,0,0.55) 100%)`;
        return;
      }

      const cx = Math.round(rect.left + rect.width / 2);
      const cy = Math.round(rect.top + rect.height / 2);
      const halfW = rect.width / 2;
      const halfH = rect.height / 2;
      const r = Math.ceil(Math.sqrt(halfW * halfW + halfH * halfH) + 28);
      overlay.style.removeProperty('background');
      overlay.style.setProperty('--spot-x', cx + 'px');
      overlay.style.setProperty('--spot-y', cy + 'px');
      overlay.style.setProperty('--spot-r', r + 'px');
      overlay.style.background =
        `radial-gradient(circle at ${cx}px ${cy}px, rgba(0,0,0,0) calc(${r}px - 6px), rgba(0,0,0,0.55) calc(${r}px - 6px + 8px))`;
    }

    function moveMentorToTarget(targetRect) {
      const mentor = tourState.mentorEl;
      const bubble = tourState.bubbleEl;
      if (!mentor || !bubble) return;

      const margin = 12;
      let preferredLeft = Math.min(window.innerWidth - mentor.offsetWidth - 16, targetRect.right + 12);
      let preferredTop = targetRect.top + (targetRect.height / 2) - (mentor.offsetHeight / 2);

      if (preferredLeft + mentor.offsetWidth + margin > window.innerWidth - 8) {
        preferredLeft = Math.max(margin, targetRect.left - mentor.offsetWidth - 12);
      }
      if (preferredLeft < margin) preferredLeft = margin;

      let left = Math.round(preferredLeft);
      let top = Math.round(preferredTop);
      if (top < margin) top = margin + 16;
      if (top + mentor.offsetHeight + margin > window.innerHeight) top = window.innerHeight - mentor.offsetHeight - margin;

      mentor.style.left = `${left}px`;
      mentor.style.top = `${top}px`;

      const bubbleLeft = left - (bubble.offsetWidth / 2) + (mentor.offsetWidth / 2);
      let bubbleTop = top - bubble.offsetHeight - 12;
      if (bubbleTop < 12) bubbleTop = top + mentor.offsetHeight + 12;
      bubble.style.left = `${Math.max(12, Math.min(window.innerWidth - bubble.offsetWidth - 12, bubbleLeft))}px`;
      bubble.style.top = `${Math.max(12, Math.min(window.innerHeight - bubble.offsetHeight - 12, bubbleTop))}px`;

      // show bubble with animation
      bubble.classList.add('show');
    }

    function focusOnSelector(selector) {
      const target = document.querySelector(selector);
      if (target) {
        target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        return new Promise((resolve) => {
          setTimeout(() => {
            const rect = target.getBoundingClientRect();
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            target.classList.add('tour-highlight');
            resolve(rect);
          }, 520);
        });
      } else {
        // placeholder rect (center)
        return new Promise((resolve) => {
          setTimeout(() => resolve({ left: window.innerWidth / 2 - 60, top: window.innerHeight / 2 - 60, right: window.innerWidth / 2 + 60, width:120, height:120 }), 350);
        });
      }
    }

    /* -----------------------------
       Typing effect helpers
       ----------------------------- */
    function setMentorStateImage(tutorKeyRaw, state = 'normal') {
      const tutorKey = normalizeTutorKey(tutorKeyRaw);
      const list = (TUTOR_IMG_VARIANTS[tutorKey] || []).slice();
      const prioritized = [];
      const stateLower = state.toLowerCase().replace('ñ','n');
      list.forEach(fn => {
        const lower = fn.toLowerCase();
        if (lower.includes(stateLower) || lower.includes(stateLower.replace('n','ñ'))) prioritized.push(fn);
      });
      const combined = prioritized.concat(list.filter(x => !prioritized.includes(x)));
      // set first valid
      getFirstValidImage(combined).then(img => {
        if (img && tourState.mentorEl) {
          tourState.mentorEl.src = img.src;
        }
      });
    }

    let typingTimer = null;
    function typeText(containerEl, text, speed = 18, cb) {
      tourState.typingLock = true;
      containerEl.innerHTML = '';
      let i = 0;
      // set mentor to 'enseñando' state
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      setMentorStateImage(profile.assignedTutor || '', 'enseñando');

      typingTimer = setInterval(() => {
        containerEl.innerHTML += text[i] === ' ' ? ' ' : text[i];
        i++;
        if (i >= text.length) {
          clearInterval(typingTimer);
          typingTimer = null;
          tourState.typingLock = false;
          setTimeout(() => {
            setMentorStateImage(profile.assignedTutor || '', 'normal');
          }, 350);
          if (cb) cb();
        }
      }, speed);
    }

    function finishTypingNow() {
      if (!tourState.typingLock) return;
      clearInterval(typingTimer);
      const bubbleTextEl = tourState.bubbleEl.querySelector('.bubble-text');
      const step = tourState.steps[tourState.step];
      bubbleTextEl.innerHTML = step ? step.text : '';
      tourState.typingLock = false;
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      setMentorStateImage(profile.assignedTutor || '', 'normal');
    }

    /* -----------------------------
       show step & navigation
       ----------------------------- */
    async function showTourStep() {
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      const step = tourState.steps[tourState.step];
      const bubble = tourState.bubbleEl;
      const mentor = tourState.mentorEl;
      if (!step || !bubble || !mentor) return endTour();

      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      focusOnSelector(step.sel).then(async rect => {
        setSpotlightForRect(rect);
        moveMentorToTarget(rect);

        bubble.querySelector('#tour-bubble-content strong').textContent = step.title || '';
        const bubbleTextEl = bubble.querySelector('.bubble-text');

        await setMentorStateImage(profile.assignedTutor || '', 'enseñando');

        typeText(bubbleTextEl, step.text || '', 18);

        const nextBtn = bubble.querySelector('#tour-next');
        nextBtn.textContent = (tourState.step === tourState.steps.length - 1) ? 'Finalizar' : 'Siguiente';
      });
    }

    function startTour(profile) {
      if (tourState.active) return;
      tourState.steps = buildTourSteps(profile);
      tourState.step = 0;
      createTourUI(profile);
      tourState.active = true;
      setTimeout(() => showTourStep(), 350);
    }

    function endTour(skipSave = false) {
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
      if (tourState.overlayEl) tourState.overlayEl.remove();
      if (tourState.mentorEl) tourState.mentorEl.remove();
      if (tourState.bubbleEl) tourState.bubbleEl.remove();
      tourState = { active:false, step:0, steps:[], overlayEl:null, mentorEl:null, bubbleEl:null, typingLock:false, typingTimer:null };
      if (!skipSave) localStorage.setItem('tutorialCompleted', 'true');
    }

    /* -----------------------------
       UI events wiring
       ----------------------------- */
    document.getElementById('add-goal-btn')?.addEventListener('click', () => window.location.href = 'dashboard.html');
    document.getElementById('view-dashboard-btn')?.addEventListener('click', () => window.location.href = 'dashboard.html');
    document.getElementById('coins-details')?.addEventListener('click', () => window.location.href = 'dashboard.html');

    document.getElementById('reset-button')?.addEventListener('click', () => {
      const confirmText = prompt('Escribe "CONFIRMAR" para borrar tu perfil y reiniciar:');
      if (confirmText && confirmText.toUpperCase() === 'CONFIRMAR') {
        localStorage.removeItem(PROFILE_KEY);
        localStorage.removeItem('tutorialCompleted');
        window.location.href = './onboarding.html';
      }
    });

    document.getElementById('repeat-tour-btn')?.addEventListener('click', async () => {
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      // remove completed flag so it restarts
      localStorage.removeItem('tutorialCompleted');
      startTour(profile);
    });

    document.getElementById('signout-btn')?.addEventListener('click', async () => {
      // stub sign out: implement your sign out (firebase or other)
      alert('Cerrar sesión (implementa signOut real).');
    });

    window.addEventListener('resize', () => {
      if (tourState.active && tourState.steps.length > 0) {
        const step = tourState.steps[tourState.step];
        const el = document.querySelector(step.sel);
        if (el) {
          const rect = el.getBoundingClientRect();
          setSpotlightForRect(rect);
          moveMentorToTarget(rect);
        }
      }
    });

    /* -----------------------------
       INIT: load profile and maybe auto-start tour
       ----------------------------- */
    (async function init() {
      const profile = await loadProfile();
      if (!profile) {
        window.location.href = './onboarding.html';
        return;
      }
      await displayProfile(profile);
      const seen = localStorage.getItem('tutorialCompleted');
      if (!seen) {
        // delay small para que UI termine de pintar
        setTimeout(() => startTour(profile), 650);
      }
    })();

  </script>

</body>
</html>
