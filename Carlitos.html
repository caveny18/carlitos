<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carlitos Home | Mi Progreso</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    body { font-family: 'Inter', sans-serif; background-color: #0d0a1b; color: #e4e6eb; padding-bottom: 100px; }
    .card { background-color: #1a1628; box-shadow: 0 8px 15px rgba(0,0,0,.4); border: 1px solid #2a243d; }
    .text-gradient { background-image: linear-gradient(90deg,#6b46c1,#9f7aea); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }

    /* Mentor floating (idle) */
    @keyframes floaty { 0% { transform: translateY(0); } 50% { transform: translateY(-8px); } 100% { transform: translateY(0); } }
    .mentor-float { animation: floaty 3s ease-in-out infinite; border-radius: 12px; }

    /* Mentor movement transitions (we'll update left/top via JS) */
    .mentor-image-tour {
      width: 120px; height: 120px; border-radius: 12px; overflow: hidden;
      display:flex; align-items:center; justify-content:center; background: transparent;
      border: 3px solid #6b46c1; position: fixed; z-index: 9999;
      transition: transform 700ms cubic-bezier(.22,.9,.32,1), left 700ms cubic-bezier(.22,.9,.32,1), top 700ms cubic-bezier(.22,.9,.32,1);
      box-shadow: 0 18px 40px rgba(0,0,0,0.55);
    }

    /* speech bubble anchored to mentor */
    .mentor-bubble {
      position: fixed;
      z-index: 9998;
      max-width: 360px;
      background: linear-gradient(180deg,#0f0b19,#161023);
      border:1px solid rgba(159,122,234,.12);
      color: #e6e7ea;
      padding: 12px 14px;
      border-radius: 12px;
      box-shadow: 0 12px 40px rgba(0,0,0,.6);
      transition: left 700ms cubic-bezier(.22,.9,.32,1), top 700ms cubic-bezier(.22,.9,.32,1), transform 300ms;
    }
    .mentor-bubble:after {
      content: '';
      position: absolute;
      width: 16px; height: 16px;
      background: linear-gradient(180deg,#0f0b19,#161023);
      border-left:1px solid rgba(159,122,234,.12);
      border-bottom:1px solid rgba(159,122,234,.12);
      transform: rotate(45deg);
      left: 18px;
      bottom: -8px;
    }

    /* highlighted target */
    .tour-highlight { position: relative; box-shadow: 0 0 0 6px rgba(159,122,234,.08), 0 18px 40px rgba(0,0,0,.6) !important; border-radius: .75rem !important; z-index: 9997; }

    /* Tour overlay (dim) */
    .tour-overlay { position: fixed; inset: 0; background: rgba(3,3,7,0.5); z-index: 9995; }

    /* bubble controls & style */
    .tour-controls { display:flex; gap:8px; justify-content:flex-end; margin-top:8px; }
    .btn-ghost { background: transparent; border: 1px solid rgba(255,255,255,.06); padding:8px 12px; border-radius: 10px; color: #e6e7ea; }
    .btn-primary { background: linear-gradient(90deg,#9f7aea,#6b46c1); color: white; padding:8px 14px; border-radius: 10px; font-weight:700; }

    /* responsive */
    @media (max-width:640px) {
      .mentor-image-tour { width: 96px; height: 96px; }
      .mentor-bubble { max-width: 280px; padding: 10px 12px; }
    }
  </style>
</head>
<body class="p-4 sm:p-8 flex justify-center min-h-screen">

  <div class="w-full max-w-2xl space-y-8 mt-6">

    <header class="flex items-start justify-between">
      <div>
        <h1 class="text-5xl font-extrabold text-gradient">Carlitos Home</h1>
        <p id="welcome-message" class="text-xl text-gray-300 mt-2">¬°Bienvenido a tu viaje financiero!</p>
      </div>
      <div class="flex items-start gap-3">
        <button id="repeat-tour-btn" class="btn-ghost" title="Repetir Tour">üéì Repetir Tour Guiado</button>
        <button id="signout-btn" class="btn-ghost" title="Cerrar sesi√≥n">Salir</button>
      </div>
    </header>

    <!-- Profile + XP -->
    <section id="progress-card" class="card rounded-2xl p-6 sm:p-8 space-y-5">
      <div class="flex flex-col sm:flex-row items-center justify-between border-b pb-4 border-gray-700/50">
        <div class="flex items-center space-x-4">
          <div id="user-avatar" class="w-16 h-16 bg-purple-600/50 rounded-full flex items-center justify-center text-3xl font-bold text-white shadow-xl flex-shrink-0">
            <span id="name-initial">C</span>
          </div>
          <div>
            <p class="text-2xl font-bold text-white" id="user-name-display"></p>
            <p class="text-sm font-semibold text-gray-400" id="user-role-display"></p>
          </div>
        </div>

        <div class="flex items-center space-x-3 mt-4 sm:mt-0 bg-gray-800/50 px-4 py-2 rounded-full border border-gray-700">
          <span class="text-xl text-yellow-400">üí∞</span>
          <div class="text-right">
            <p class="text-xs text-yellow-500 font-medium uppercase">Mi CarlitosCoin</p>
            <p class="text-xl font-bold text-white" id="user-coins">0</p>
          </div>
          <div class="ml-4">
            <button id="coins-details" class="btn-ghost">Ver m√°s detalles</button>
          </div>
        </div>
      </div>

      <div>
        <div class="flex justify-between items-end mb-2">
          <p class="text-lg font-bold text-purple-400" id="user-level-title">Nivel: Novato</p>
          <p class="text-sm text-gray-400">XP: <span id="user-xp-current">0</span>/<span id="user-xp-next">100</span></p>
        </div>
        <div id="xp-bar-container">
          <div id="xp-bar-fill" style="width:0%"></div>
        </div>
        <p class="text-xs text-gray-500 mt-2 text-center" id="next-level-message">Sigue completando misiones para alcanzar el siguiente nivel.</p>
      </div>
    </section>

    <!-- Tools -->
    <section id="tools-section" class="card rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold mb-5 flex items-center text-cyan-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3 text-cyan-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M11.42 15.17L17.25 21 21 17.25M12 1.5l8.69 8.69a1.688 1.688 0 0 1 .286 1.15l-.675 6.471a1.5 1.5 0 0 1-1.472 1.393H9.866a1.5 1.5 0 0 1-1.472-1.393L7.72 12.01l-5.694-5.694a1.875 1.875 0 0 1 2.652-2.652L10.5 10.5M4.125 15.875a1.875 1.875 0 1 0 0-3.75 1.875 1.875 0 0 0 0 3.75Z"/></svg>
        Mi Caja de Herramientas
      </h2>

      <div id="tool-list" class="space-y-3">
        <!-- populated by JS -->
      </div>

      <p class="text-xs text-gray-500 mt-4 text-center">¬°Sigue aprendiendo en la secci√≥n "Aprender" para desbloquear m√°s herramientas!</p>
    </section>

    <!-- Goals -->
    <section id="goals-section" class="card rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold mb-5 flex items-center text-pink-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3 text-pink-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.079 0-2.157.26-3.228.784-0.124.057-0.209.18-0.209.311v11.977c0 0.285.231.516.516.516h13.048c.285 0 .516-.231.516-.516V4.845c0-.131-.085-.254-.209-.311A8.967 8.967 0 0 0 18 3.75c1.079 0 2.157.26 3.228.784"/></svg>
        Tus Metas Financieras
      </h2>

      <div id="user-goals-summary" class="text-gray-400 space-y-3">
        <!-- metas renderizadas por JS -->
      </div>

      <div class="pt-4 border-t border-gray-700/40 flex justify-between items-center">
        <p class="text-xs text-pink-300">Gestiona y crea metas desde el Dashboard.</p>
        <div class="flex gap-3">
          <button id="add-goal-btn" class="btn-primary">Agregar nueva meta</button>
          <button id="view-dashboard-btn" class="btn-ghost">Ir al Dashboard</button>
        </div>
      </div>
    </section>

    <!-- Mentor card -->
    <section id="mentor-section" class="card rounded-2xl p-6 sm:p-8">
      <h2 class="text-2xl font-bold mb-5 flex items-center text-purple-400">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 mr-3 text-purple-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M9 12h3.75M9 15h3.75M9 18h3.75m-4.5 0A2.25 2.25 0 0 1 7.5 21h4.5a2.25 2.25 0 0 1 2.25-2.25m3.75-9a4.5 4.5 0 1 1-9 0"/></svg>
        Tu Carlitos Mentor: <span class="text-white ml-1" id="tutor-name">Kantu</span>
      </h2>

      <div class="flex flex-col sm:flex-row items-center sm:items-start space-y-4 sm:space-y-0 sm:space-x-6 bg-gray-800/30 p-4 rounded-xl border border-purple-500/20">
        <div class="w-20 h-20 flex-shrink-0">
          <div id="tutor-icon-container" class="w-full h-full tutor-image-active flex items-center justify-center text-4xl" style="background-color:#2a243d; border-radius:50%;">
            <!-- svg or emoji -->
          </div>
        </div>

        <div class="text-center sm:text-left">
          <p class="text-lg font-semibold text-purple-300" id="tutor-role"></p>
          <p class="text-base text-gray-300 mt-2" id="tutor-description"></p>
          <div class="pt-4 mt-4 border-t border-gray-700/50">
            <p class="text-lg font-semibold text-white">Pr√≥xima Misi√≥n:</p>
            <p class="text-purple-400 font-medium" id="first-mission-text"></p>
          </div>
        </div>
      </div>
    </section>

    <div class="text-center pt-2 pb-10">
      <button id="reset-button" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-full">Reiniciar Onboarding (Borrar Perfil)</button>
    </div>
  </div>

  <!-- Nav -->
  <nav class="nav-menu fixed bottom-0 left-0 right-0 bg-[#100c1d] border-t border-gray-800 z-40">
    <div class="flex justify-around max-w-2xl mx-auto py-2">
      <a href="./dashboard.html" class="nav-item text-center">
        <div class="nav-item inline-flex flex-col items-center text-gray-400">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 10.5h19.5m-4.5 4.5h-10.5m10.5 0a1.5 1.5 0 0 1 1.5 1.5v3.75a1.5 1.5 0 0 1-1.5 1.5h-10.5a1.5 1.5 0 0 1-1.5-1.5V16.5m1.5-6.042V4.5a1.5 1.5 0 0 1 1.5-1.5h7.5" /></svg>
          <span class="text-xs">Dashboard</span>
        </div>
      </a>
      <a href="./Aprender.html" class="nav-item text-center">
        <div class="inline-flex flex-col items-center text-gray-400">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21.5L4 17.5V7.5L12 3.5L20 7.5V17.5L12 21.5Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 12L20 7.5M12 12V21.5M12 12L4 7.5M4 17.5L12 12M20 17.5L12 12" /></svg>
          <span class="text-xs">Aprender</span>
        </div>
      </a>
      <a href="./Microaprendizaje.html" class="nav-item text-center">
        <div class="inline-flex flex-col items-center text-gray-400">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="m15 10.5 4.793-4.793a1 1 0 0 0 0-1.414l-2.06-2.06a1 1 0 0 0-1.414 0L12 7.086 8.707 3.793a1 1 0 0 0-1.414 0l-2.06 2.06a1 1 0 0 0 0 1.414L9 10.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="text-xs">Micro</span>
        </div>
      </a>
      <a href="./Carlitos.html" class="nav-item active text-center">
        <div class="inline-flex flex-col items-center text-purple-400">
          <svg class="w-6 h-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0Z" stroke-linecap="round" stroke-linejoin="round"/><path d="M4.501 20.118a7.5 7.5 0 0 1 14.998 0A17.933 17.933 0 0 1 12 21.75c-2.676 0-5.216-.584-7.499-1.632Z" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <span class="text-xs">Perfil</span>
        </div>
      </a>
    </div>
  </nav>

  <!-- TOUR elements are created by JS -->

  <script type="module">
    import { db, auth } from './firebase-config.js';
    import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js';
    import { onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js';

    const PROFILE_KEY = 'carlitos_profile_data';

    // DOM refs
    const DOM = {
      welcome: document.getElementById('welcome-message'),
      nameInitial: document.getElementById('name-initial'),
      userName: document.getElementById('user-name-display'),
      userRole: document.getElementById('user-role-display'),
      userCoins: document.getElementById('user-coins'),
      xpCurrent: document.getElementById('user-xp-current'),
      xpNext: document.getElementById('user-xp-next'),
      xpFill: document.getElementById('xp-bar-fill'),
      levelTitle: document.getElementById('user-level-title'),
      nextLevelMsg: document.getElementById('next-level-message'),
      toolList: document.getElementById('tool-list'),
      goalsSummary: document.getElementById('user-goals-summary'),
      addGoalBtn: document.getElementById('add-goal-btn'),
      viewDashboardBtn: document.getElementById('view-dashboard-btn'),
      coinsDetailsBtn: document.getElementById('coins-details'),
      tutorName: document.getElementById('tutor-name'),
      tutorRole: document.getElementById('tutor-role'),
      tutorDesc: document.getElementById('tutor-description'),
      tutorIcon: document.getElementById('tutor-icon-container'),
      tutorMission: document.getElementById('first-mission-text'),
      resetBtn: document.getElementById('reset-button'),
      repeatTourBtn: document.getElementById('repeat-tour-btn'),
      signoutBtn: document.getElementById('signout-btn'),
    };

    // Levels & Tools
    const LEVELS = [
      { name: "Novato", minXP: 0, maxXP: 100, title: "El Curioso", toolsRequired: 0 },
      { name: "Aprendiz", minXP: 100, maxXP: 350, title: "El Experimentador", toolsRequired: 1 },
      { name: "Estratega", minXP: 350, maxXP: 800, title: "El Analista", toolsRequired: 3 },
      { name: "Maestro", minXP: 800, maxXP: 1500, title: "El Optimizador", toolsRequired: 6 },
      { name: "Leyenda", minXP: 1500, maxXP: 99999, title: "El Inmortal", toolsRequired: 10 },
    ];
    const ALL_TOOLS = [
      { id: 'registro_gastos', name: 'Registro de Ingresos y Gastos', requiredLevel: 1 },
      { id: 'planificador_presupuesto', name: 'Planificador de Presupuesto (50/30/20)', requiredLevel: 2 },
      { id: 'simulador_inversiones', name: 'Simulador de Inversiones B√°sicas', requiredLevel: 3 },
      { id: 'control_deuda', name: 'Control de Deuda', requiredLevel: 4 },
    ];

    // Tutor visuals
    const TUTOR_DATA = {
      'Kantu': {
        role: 'El Ilustrador (Empezando)',
        description: 'Te motivar√° con humor y simplificar√° cualquier concepto dif√≠cil. Tu camino ser√° paso a paso y sin presiones.',
        mission: (goal) => `Comienza con el reto de presupuesto de 5 minutos para avanzar en **${goal || 'tu objetivo'}**.`,
        svg: '<span class="text-5xl">üêí</span>',
        teachImage: 'monoense√±ando.png'
      },
      'Saison': {
        role: 'El Explorador (Aprendiendo)',
        description: 'Te animar√° a experimentar con nuevas herramientas y h√°bitos, manteniendo viva tu curiosidad.',
        mission: (goal) => `Explora m√©todos de ahorro r√°pido y crea un plan semanal para **${goal || 'tu meta'}**.`,
        svg: '<span class="text-5xl">üêøÔ∏è</span>',
        teachImage: 'ardillaense√±ando.png'
      },
      'Inti': {
        role: 'El Estratega (Mejorando)',
        description: 'Te dar√° estructura y visi√≥n a mediano plazo para optimizar tus finanzas.',
        mission: (goal) => `Analiza tu flujo de caja y busca optimizaciones para **${goal || 'tu meta'}**.`,
        svg: '<span class="text-5xl">ü¶Ö</span>',
        teachImage: 'condorense√±ando.png'
      },
      'Auki': {
        role: 'El Optimizador (Avanzado)',
        description: 'Actuar√° como consejero avanzado para estrategias de inversi√≥n.',
        mission: (goal) => `Revisa o simula un portafolio para optimizar **${goal || 'tu meta'}**.`,
        svg: '<span class="text-5xl">üê±</span>',
        teachImage: 'leopardoense√±ando.png'
      }
    };

    // Utils
    function calculateProgress(totalXp) {
      let currentLevel = LEVELS[0];
      let progressPercentage = 0;
      for (let i = 0; i < LEVELS.length; i++) {
        if (totalXp < LEVELS[i].maxXP) {
          currentLevel = LEVELS[i];
          const xpInLevel = totalXp - currentLevel.minXP;
          const levelRange = currentLevel.maxXP - currentLevel.minXP;
          progressPercentage = (xpInLevel / levelRange) * 100;
          return { level: currentLevel, progressPercentage, xpToNextLevel: currentLevel.maxXP, currentLevelXp: totalXp };
        }
      }
      const lastLevel = LEVELS[LEVELS.length - 1];
      return { level: lastLevel, progressPercentage: 100, xpToNextLevel: lastLevel.maxXP, currentLevelXp: totalXp };
    }

    function renderToolList(level) {
      const container = DOM.toolList;
      container.innerHTML = '';
      const userLevelNumber = LEVELS.findIndex(l => l.name === level.name) + 1;
      ALL_TOOLS.forEach(tool => {
        const isUnlocked = tool.requiredLevel <= userLevelNumber;
        const div = document.createElement('div');
        div.className = `flex items-center justify-between p-3 rounded-lg transition ${isUnlocked ? 'bg-gray-800/30' : 'bg-gray-900/40 opacity-60'}`;
        div.innerHTML = `
          <span class="${isUnlocked ? 'text-gray-300' : 'text-gray-500'} flex items-center">
            ${isUnlocked ? '<span class="mr-3 text-xl text-green-400">‚úÖ</span>' : '<span class="mr-3 text-xl text-red-500">üîí</span>'}
            ${tool.name}
          </span>
          <span class="${isUnlocked ? 'text-green-400' : 'text-gray-500'} text-xs font-bold">Nivel ${tool.requiredLevel}</span>
        `;
        container.appendChild(div);
      });
    }

    function renderGoals(goals = []) {
      const container = DOM.goalsSummary;
      container.innerHTML = '';
      if (!goals || goals.length === 0) {
        container.innerHTML = `<p class="text-gray-400">A√∫n no tienes metas. Crea tu primera meta en el Dashboard.</p>`;
        return;
      }
      goals.forEach((g, idx) => {
        const current = Number(g.current || 0);
        const target = Number(g.target || 1);
        const pct = Math.min(100, Math.round((current / target) * 100));
        const goalDiv = document.createElement('div');
        goalDiv.className = 'p-3 bg-gray-800/30 rounded-lg';
        goalDiv.innerHTML = `
          <div class="flex justify-between items-start">
            <div>
              <p class="font-semibold text-gray-200">${g.title || 'Meta #' + (idx+1)}</p>
              <p class="text-xs text-gray-400">${(current).toLocaleString('es-CL')} / ${(target).toLocaleString('es-CL')}</p>
            </div>
            <div class="text-xs text-pink-300 font-bold">${pct}%</div>
          </div>
          <div class="mt-2 w-full bg-gray-900/50 rounded-full h-3 overflow-hidden">
            <div style="width:${pct}%" class="h-3 bg-gradient-to-r from-pink-500 to-pink-300"></div>
          </div>
          <div class="mt-3 flex justify-end">
            <button class="btn-ghost view-meta-detail" data-index="${idx}">Ver detalle</button>
          </div>
        `;
        container.appendChild(goalDiv);
      });

      container.querySelectorAll('.view-meta-detail').forEach(btn => {
        btn.addEventListener('click', () => {
          const idx = btn.dataset.index;
          window.location.href = `dashboard.html?goal=${idx}`;
        });
      });
    }

    // Display profile
    function displayProfile(profile = {}) {
      profile.totalXP = Number(profile.totalXP || 0);
      profile.carlitosCoins = Number(profile.carlitosCoins || 0);
      profile.primaryGoal = profile.primaryGoal || 'tu objetivo';
      profile.goals = profile.goals || [];

      const prog = calculateProgress(profile.totalXP);
      DOM.welcome.textContent = `¬°Bienvenido, ${profile.name || 'amigo'}!`;
      DOM.nameInitial.textContent = (profile.name || 'C')[0]?.toUpperCase() || 'C';
      DOM.userName.textContent = profile.name || 'Usuario';
      DOM.userRole.textContent = profile.role || '';
      DOM.userCoins.textContent = profile.carlitosCoins.toLocaleString('es-CL');
      DOM.xpCurrent.textContent = prog.currentLevelXp;
      DOM.xpNext.textContent = prog.level.name === 'Leyenda' ? 'MAX' : prog.xpToNextLevel.toLocaleString('es-CL');
      DOM.levelTitle.textContent = `${prog.level.name} (${prog.level.title})`;
      DOM.xpFill.style.width = `${prog.progressPercentage}%`;
      DOM.nextLevelMsg.textContent = prog.level.name === 'Leyenda' ? '¬°Has alcanzado el m√°ximo dominio!' : `Te faltan ${prog.xpToNextLevel - prog.currentLevelXp} XP para ser ${LEVELS[Math.min(LEVELS.length-1, LEVELS.findIndex(l => l.name === prog.level.name) + 1)].name}.`;

      renderToolList(prog.level);
      renderGoals(profile.goals);

      const tutorKey = profile.assignedTutor || 'Kantu';
      const tutorInfo = TUTOR_DATA[tutorKey] || TUTOR_DATA['Kantu'];
      DOM.tutorName.textContent = tutorKey;
      DOM.tutorRole.textContent = tutorInfo.role;
      DOM.tutorDesc.textContent = tutorInfo.description;
      DOM.tutorIcon.innerHTML = tutorInfo.svg;
      DOM.tutorMission.textContent = tutorInfo.mission(profile.primaryGoal);

      localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
    }

    // Load profile preferring Firestore when signed in
    async function loadProfile() {
      return new Promise((resolve) => {
        onAuthStateChanged(auth, async (user) => {
          if (user) {
            try {
              const docRef = doc(db, 'usuarios', user.uid);
              const snap = await getDoc(docRef);
              if (snap.exists()) {
                const data = snap.data();
                const profile = {
                  name: data.name || data.nombre || user.displayName || '',
                  role: data.role || data.rol || '',
                  totalXP: data.totalXP || data.xp || 0,
                  carlitosCoins: data.carlitosCoins || data.coins || 0,
                  primaryGoal: data.primaryGoal || data.meta || '',
                  goals: data.goals || data.metas || [],
                  assignedTutor: data.assignedTutor || data.mentor || 'Kantu',
                  createdAt: data.createdAt || data.fecha || new Date().toISOString()
                };
                localStorage.setItem(PROFILE_KEY, JSON.stringify(profile));
                resolve(profile);
              } else {
                const local = localStorage.getItem(PROFILE_KEY);
                if (local) resolve(JSON.parse(local));
                else resolve({ name: user.displayName || 'Usuario', role: '', totalXP:0, carlitosCoins:0, goals: [], assignedTutor: 'Kantu', primaryGoal: '' });
              }
            } catch (e) {
              console.error('Error leyendo Firestore:', e);
              const local = localStorage.getItem(PROFILE_KEY);
              resolve(local ? JSON.parse(local) : null);
            }
          } else {
            const local = localStorage.getItem(PROFILE_KEY);
            resolve(local ? JSON.parse(local) : null);
          }
        });
      });
    }

    /* -----------------------
       TOUR: floating mentor + speech bubble + scroll + highlight
       ----------------------- */
    let tourState = { active: false, step: 0, steps: [] };

    function buildTourSteps(profile) {
      const tutorKey = profile.assignedTutor || 'Kantu';
      const teachImg = (TUTOR_DATA[tutorKey] && TUTOR_DATA[tutorKey].teachImage) ? TUTOR_DATA[tutorKey].teachImage : 'monoense√±ando.png';
      return [
        { sel: '#user-avatar', title: 'Tu perfil', text: `¬°Hola! Soy ${tutorKey} y ser√© tu mentor. Aqu√≠ ves tu avatar, nombre y rol.` },
        { sel: '#coins-details', title: 'Tus CarlitosCoins', text: 'Aqu√≠ est√° tu saldo. Pulsa "Ver m√°s detalles" para ir al Dashboard y ver movimientos.' },
        { sel: '#goals-section', title: 'Tus metas', text: 'Esta secci√≥n muestra tus metas con barras de progreso. Pulsa "Ver detalle" para ver m√°s en el Dashboard.' },
        { sel: '#tools-section', title: 'Herramientas', text: 'Aqu√≠ se muestran las herramientas que desbloqueas por nivel.' },
        { sel: '#mentor-section', title: 'Tu Mentor', text: 'Aqu√≠ puedes ver la descripci√≥n y la pr√≥xima misi√≥n que te asigno.' },
        { sel: '.nav-menu', title: 'Men√∫ inferior', text: 'Este men√∫ te permite navegar entre Dashboard, Aprender, Microaprendizaje y Perfil.' }
      ].map(s => ({ ...s, teachImg }));
    }

    function createTourUI(profile) {
      // overlay
      let overlay = document.getElementById('tour-overlay');
      if (overlay) overlay.remove();
      overlay = document.createElement('div');
      overlay.className = 'tour-overlay';
      overlay.id = 'tour-overlay';

      // mentor image element
      const tutorKey = profile.assignedTutor || 'Kantu';
      const imgSrc = (TUTOR_DATA[tutorKey] && TUTOR_DATA[tutorKey].teachImage) ? TUTOR_DATA[tutorKey].teachImage : 'monoense√±ando.png';

      const mentorImg = document.createElement('img');
      mentorImg.id = 'tour-mentor-image';
      mentorImg.className = 'mentor-image-tour mentor-float';
      mentorImg.src = imgSrc;
      mentorImg.alt = 'Mentor';
      mentorImg.onerror = () => { mentorImg.src = 'monoense√±ando.png'; };

      // speech bubble
      const bubble = document.createElement('div');
      bubble.id = 'tour-mentor-bubble';
      bubble.className = 'mentor-bubble';
      bubble.style.left = '20px';
      bubble.style.top = '20px';
      bubble.innerHTML = `<div id="tour-bubble-content"><strong>Hola</strong><p></p></div><div class="tour-controls" style="margin-top:8px;"><button id="tour-skip" class="btn-ghost">Omitir</button><button id="tour-prev" class="btn-ghost">Atr√°s</button><button id="tour-next" class="btn-primary">Siguiente</button></div>`;

      overlay.appendChild(mentorImg);
      overlay.appendChild(bubble);
      document.body.appendChild(overlay);
    }

    // move mentor image & bubble to a target rect (mentor will sit to top-right of target)
    function moveMentorToTarget(targetRect) {
      const mentor = document.getElementById('tour-mentor-image');
      const bubble = document.getElementById('tour-mentor-bubble');
      if (!mentor || !bubble) return;

      // compute desired mentor position: top-right of target, but keep inside viewport
      const margin = 12;
      const preferredLeft = targetRect.right + 12; // to the right
      const preferredTop = targetRect.top - (mentor.offsetHeight / 2);

      // fallback: if not enough space right, place to left
      let left = preferredLeft;
      if (preferredLeft + mentor.offsetWidth + margin > window.innerWidth) {
        left = Math.max(margin, targetRect.left - mentor.offsetWidth - 12);
      }
      // clamp vertically
      let top = preferredTop;
      if (top < margin) top = margin + 20;
      if (top + mentor.offsetHeight + margin > window.innerHeight) top = window.innerHeight - mentor.offsetHeight - margin;

      // animate by setting left/top
      mentor.style.left = `${left}px`;
      mentor.style.top = `${top}px`;

      // position bubble close to mentor (above or left depending)
      const bubbleLeft = left - (bubble.offsetWidth / 2) + (mentor.offsetWidth / 2);
      let bubbleTop = top - bubble.offsetHeight - 14;
      if (bubbleTop < 12) bubbleTop = top + mentor.offsetHeight + 12; // put below if not enough above
      bubble.style.left = `${Math.max(12, Math.min(window.innerWidth - bubble.offsetWidth - 12, bubbleLeft))}px`;
      bubble.style.top = `${bubbleTop}px`;
    }

    // scroll to target and highlight
    function focusOnSelector(selector) {
      const target = document.querySelector(selector);
      if (target) {
        // scroll so the element is visible (center-ish)
        target.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });
        // compute rect after a small delay to allow scroll
        return new Promise((resolve) => {
          setTimeout(() => {
            const rect = target.getBoundingClientRect();
            // add highlight class
            target.classList.add('tour-highlight');
            // remove after tour finishes
            resolve(rect);
          }, 520); // should match animation timing nicely
        });
      } else {
        // center on screen
        return new Promise((resolve) => {
          setTimeout(() => resolve({ left: window.innerWidth / 2 - 60, top: window.innerHeight / 2 - 60, right: window.innerWidth / 2 + 60 }), 350);
        });
      }
    }

    function showTourStep() {
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      const step = tourState.steps[tourState.step];
      const bubble = document.getElementById('tour-mentor-bubble');
      const mentor = document.getElementById('tour-mentor-image');
      if (!step || !bubble || !mentor) return endTour();

      // clear previous highlights
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      focusOnSelector(step.sel).then(rect => {
        // move mentor to a nice place relative to rect
        moveMentorToTarget(rect);

        // set bubble text
        const content = bubble.querySelector('#tour-bubble-content p');
        bubble.querySelector('#tour-bubble-content strong').textContent = step.title || '';
        content.textContent = step.text || '';

        // set controls
        const nextBtn = document.getElementById('tour-next');
        const prevBtn = document.getElementById('tour-prev');
        const skipBtn = document.getElementById('tour-skip');

        nextBtn.textContent = (tourState.step === tourState.steps.length - 1) ? 'Finalizar' : 'Siguiente';

        nextBtn.onclick = () => {
          // remove highlight for current target (so next highlight stands out)
          document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
          tourState.step++;
          if (tourState.step >= tourState.steps.length) return endTour();
          showTourStep();
        };
        prevBtn.onclick = () => {
          if (tourState.step > 0) {
            document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
            tourState.step--;
            showTourStep();
          }
        };
        skipBtn.onclick = () => endTour(true);
      });
    }

    function startTour(profile) {
      if (tourState.active) return;
      tourState.steps = buildTourSteps(profile);
      tourState.step = 0;
      createTourUI(profile);
      tourState.active = true;

      // give a moment for DOM nodes to exist, then show first step
      setTimeout(() => showTourStep(), 300);
    }

    function endTour(skipSave = false) {
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));
      const overlay = document.getElementById('tour-overlay');
      if (overlay) overlay.remove();
      tourState.active = false;
      if (!skipSave) localStorage.setItem('tutorialCompleted', 'true');
    }

    /* -----------------------
       UI events wiring
       ----------------------- */
    DOM.addGoalBtn?.addEventListener('click', () => window.location.href = 'dashboard.html');
    DOM.viewDashboardBtn?.addEventListener('click', () => window.location.href = 'dashboard.html');
    DOM.coinsDetailsBtn?.addEventListener('click', () => window.location.href = 'dashboard.html');

    DOM.resetBtn?.addEventListener('click', () => {
      const confirmText = prompt('Escribe "CONFIRMAR" para borrar tu perfil y reiniciar:');
      if (confirmText && confirmText.toUpperCase() === 'CONFIRMAR') {
        localStorage.removeItem(PROFILE_KEY);
        localStorage.removeItem('tutorialCompleted');
        window.location.href = './onboarding.html';
      }
    });

    DOM.repeatTourBtn?.addEventListener('click', async () => {
      const profile = JSON.parse(localStorage.getItem(PROFILE_KEY) || '{}') || {};
      startTour(profile);
    });

    DOM.signoutBtn?.addEventListener('click', async () => {
      try {
        await signOut(auth);
        localStorage.removeItem('userUID');
        window.location.href = './index.html';
      } catch (e) {
        console.error('Error sign out', e);
        alert('No se pudo cerrar sesi√≥n');
      }
    });

    // goal detail navigation from goals list is wired in renderGoals

    // Init: load profile and maybe auto-start tour
    (async function init() {
      const profile = await loadProfile();
      if (!profile) {
        window.location.href = './onboarding.html';
        return;
      }
      displayProfile(profile);
      const seen = localStorage.getItem('tutorialCompleted');
      if (!seen) {
        setTimeout(() => startTour(profile), 650);
      }
    })();

  </script>
</body>
</html>
