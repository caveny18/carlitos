<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bienvenido a Carlitos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
    :root {
      --bg1: #0b1020;
      --bg2: #071129;
      --accentA: #06b6d4; /* azul/verde Carlitos */
      --accentB: #10b981;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top, var(--bg1) 0%, var(--bg2) 80%);
      color: #f8fafc;
      min-height: 100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:28px;
      margin:0;
    }
    .card {
      width:100%;
      max-width:720px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.04);
      border-radius: 18px;
      padding:28px;
      box-shadow: 0 30px 90px rgba(2,6,23,0.6);
      text-align:center;
    }
    .img-welcome { width:280px; max-width:60%; border-radius:16px; display:block; margin:0 auto 18px; }
    .title { font-size:28px; font-weight:800; margin-bottom:6px; }
    .subtitle { color: rgba(255,255,255,0.8); margin-bottom:18px; }
    .btn {
      display:inline-flex; align-items:center; justify-content:center;
      gap:8px; padding:12px 18px; border-radius:12px; font-weight:700; cursor:pointer;
      border:0;
    }
    .btn-google { background: linear-gradient(90deg, var(--accentA), var(--accentB)); color:#042; box-shadow: 0 12px 36px rgba(6,182,212,0.12); }
    .btn-start { background: linear-gradient(90deg, #16a34a, #10b981); color:#fff; }
    .btn:active { transform: translateY(1px); }
    .muted { color: rgba(255,255,255,0.78); }

    /* toast */
    #toast-root { position: fixed; left:50%; transform: translateX(-50%); bottom:28px; z-index:99999; }
    .toast {
      display:flex; align-items:center; gap:12px;
      background: rgba(2,6,23,0.72); color:#fff;
      padding:12px 16px; border-radius:12px; min-width:280px;
      box-shadow: 0 18px 60px rgba(2,6,23,0.6);
      backdrop-filter: blur(6px);
    }
    .toast .actions { margin-left:auto; display:flex; gap:8px; }
    .toast .btn-ghost { background:transparent; border:1px solid rgba(255,255,255,0.06); color:#fff; padding:8px 10px; border-radius:8px; }
    .toast .btn-primary { background: linear-gradient(90deg,var(--accentA),var(--accentB)); color:#042; padding:8px 10px; border-radius:8px; font-weight:800; }

    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="card">
    <img class="img-welcome" src="./bienvenida.png" alt="Bienvenido a Carlitos">
    <div class="title">👋 Bienvenido a <span style="background:linear-gradient(90deg,var(--accentA),var(--accentB)); -webkit-background-clip:text; -webkit-text-fill-color:transparent">Carlitos</span></div>
    <div class="subtitle muted">Tu compañero financiero inteligente. Aprende, ahorra e invierte con nuestros mentores.</div>

    <div style="display:flex; gap:12px; justify-content:center; margin-top:14px;">
      <button id="btnLogin" class="btn btn-google">🚀 Ya tengo una cuenta</button>
      <button id="btnRegister" class="btn btn-start">🌱 Empieza ahora</button>
    </div>
    <p class="muted" style="margin-top:12px; font-size:0.95rem;">Si aún no tienes cuenta, te ayudamos a crear tu perfil en 2 minutos.</p>
  </div>

  <!-- toast mount -->
  <div id="toast-root" aria-live="polite"></div>

  <script type="module">
    // RUTAS (ajusta si tus archivos están en otras carpetas)
    const ROUTES = {
      carlitosHome: 'Carlitos.html',
      preguntasMentor: 'preguntas-mentor.html',
      onboarding: 'onboarding.html'
    };

    // helpers
    function safeNavigate(url) {
      // intento HEAD para mayor robustez; si falla, navega directo
      return fetch(url, { method: 'HEAD' }).then(r => { window.location.href = url; }).catch(()=>{ window.location.href = url; });
    }

    // Toast generator
    const toastRoot = document.getElementById('toast-root');
    function showToast({ title = '', text = '', cta = null, ctaText = 'OK', duration = 8000 } = {}) {
      // clear existing
      toastRoot.innerHTML = '';
      const t = document.createElement('div');
      t.className = 'toast';
      t.innerHTML = `
        <div>
          <div style="font-weight:800">${title}</div>
          <div style="font-size:0.95rem; opacity:0.95">${text}</div>
        </div>
      `;
      if (cta) {
        const actions = document.createElement('div');
        actions.className = 'actions';
        const btn = document.createElement('button');
        btn.className = 'btn-primary';
        btn.textContent = ctaText;
        btn.onclick = async () => { await cta(); t.remove(); };
        const dismiss = document.createElement('button');
        dismiss.className = 'btn-ghost';
        dismiss.textContent = 'Cerrar';
        dismiss.onclick = () => t.remove();
        actions.appendChild(dismiss);
        actions.appendChild(btn);
        t.appendChild(actions);
      } else {
        const dismiss = document.createElement('div');
        dismiss.style.marginLeft = '12px';
        const close = document.createElement('button');
        close.className = 'btn-ghost';
        close.textContent = 'Cerrar';
        close.onclick = () => t.remove();
        t.appendChild(close);
      }
      toastRoot.appendChild(t);
      if (duration > 0) setTimeout(()=> t.remove(), duration);
    }

    // Elementos
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');

    // Intento importar firebase-config.js que tú tienes/crearás.
    // firebase-config.js debe exportar: auth, db, provider
    let firebaseReady = false;
    let auth = null, db = null, provider = null;
    try {
      const cfg = await import('./firebase-config.js');
      auth = cfg.auth ?? cfg.default?.auth ?? null;
      db = cfg.db ?? cfg.default?.db ?? null;
      provider = cfg.provider ?? cfg.default?.provider ?? null;
      firebaseReady = !!(auth && provider);
      console.log('Firebase cargado ->', firebaseReady);
    } catch (e) {
      console.warn('firebase-config no encontrado o con error:', e);
      firebaseReady = false;
    }

    // Función: verifica si existe documento de perfil en Firestore
    async function userHasProfileInFirestore(user) {
      if (!db || !user || !user.uid) return false;
      try {
        const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js');
        const ref = doc(db, 'usuarios', user.uid);
        const snap = await getDoc(ref);
        return !!(snap && snap.exists && snap.exists());
      } catch (e) {
        console.warn('Error consultando Firestore:', e);
        return false;
      }
    }

    // Manejo click "Ya tengo una cuenta"
    btnLogin.addEventListener('click', async () => {
      btnLogin.disabled = true;
      try {
        if (!firebaseReady) {
          // no hay firebase-config -> informar y enviar a creación
          showToast({
            title: 'Sin conexión a backend',
            text: 'No se detectó la configuración de Firebase en este entorno. Te redirigimos para crear un perfil local.',
            cta: async () => await safeNavigate(ROUTES.preguntasMentor),
            ctaText: 'Crear perfil'
          });
          return;
        }

        // Sign in with Google popup
        const { signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js');
        try {
          const result = await signInWithPopup(auth, provider);
          const user = result.user;
          if (!user) {
            showToast({ title: 'Error', text: 'No se obtuvo información del usuario.' });
            return;
          }

          // guarda uid local (útil)
          localStorage.setItem('carlitos_user_uid', user.uid);

          // Verificar en Firestore si tiene perfil
          const exists = await userHasProfileInFirestore(user);
          if (exists) {
            // ✅ Tiene perfil → ir a Carlitos.html
            await safeNavigate(ROUTES.carlitosHome);
            return;
          } else {
            // ❌ No tiene perfil -> mostrar mensaje bonito y acción crear
            showToast({
              title: 'Parece que no tienes perfil',
              text: 'No encontramos un perfil asociado en Carlitos. Te ayudamos a crear uno ahora.',
              cta: async () => {
                // opcional: pre-llenar preguntas-mentor con info del usuario (por querystring)
                const qs = new URLSearchParams();
                if (user.displayName) qs.set('name', user.displayName);
                if (user.email) qs.set('email', user.email);
                await safeNavigate(ROUTES.preguntasMentor + '?' + qs.toString());
              },
              ctaText: 'Crear perfil'
            });
            return;
          }
        } catch (popupErr) {
          console.warn('signInWithPopup error:', popupErr);
          showToast({
            title: 'Inicio cancelado o fallido',
            text: 'No se completó el inicio con Google. Si no tienes cuenta, crea una ahora.',
            cta: async () => await safeNavigate(ROUTES.preguntasMentor),
            ctaText: 'Crear perfil'
          });
        }
      } finally {
        btnLogin.disabled = false;
      }
    });

    // Empieza ahora -> siempre crea perfil (preguntas-mentor)
    btnRegister.addEventListener('click', async () => {
      await safeNavigate(ROUTES.preguntasMentor);
    });

    // accesibilidad: Enter para login si no hay foco en inputs
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !['INPUT','TEXTAREA','SELECT','BUTTON'].includes(document.activeElement.tagName)) {
        btnLogin.click();
      }
    });
  </script>
</body>
</html>
