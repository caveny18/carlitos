<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carlitos — MVP Finanzas (Prototipo)</title>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --accent:#06b6d4; --muted:#94a3b8; --glass: rgba(255,255,255,0.03);
      font-family: Inter, system-ui, Arial;
    }
    body{margin:0;background:linear-gradient(180deg,#071024 0%, #081225 100%);color:#e6eef6;padding-bottom:76px;}
    .container{max-width:1100px;margin:28px auto;padding:18px;}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
    h1{font-size:20px;margin:0}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:18px}
    .card{background:var(--card);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(2,6,23,0.6);}
    form .row{display:flex;gap:8px;margin-bottom:8px}
    input,select,button,textarea{background:var(--glass);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:10px;border-radius:8px;outline:none}
    input::placeholder{color:#6b7280}
    button{background:linear-gradient(90deg,var(--accent),#7dd3fc);color:#062024;border:none;cursor:pointer;padding:10px 12px;font-weight:600}
    .kpis{display:flex;gap:8px;flex-wrap:wrap}
    .kpi{flex:1;min-width:120px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:10px;border-radius:8px}
    .small{font-size:12px;color:var(--muted)}
    ul{list-style:none;padding:0;margin:0}
    .entry{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed rgba(255,255,255,0.02)}
    .danger{color:#ff7a7a}
    .ok{color:#7ef0c7}
    .level{background:linear-gradient(90deg,#0b1220,#071024);padding:10px;border-radius:8px;margin-top:10px}
    footer{font-size:12px;color:var(--muted);text-align:center;margin-top:18px}
    .hint{font-size:13px;color:var(--muted);margin-top:8px}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px;border-radius:8px}
    .flex{display:flex;gap:8px;align-items:center}
    .mini{font-size:13px}
    /* Bottom nav */
    .bottom-nav{position:fixed;left:0;right:0;bottom:10px;display:flex;justify-content:center;pointer-events:auto;z-index:80}
    .nav-inner{width:100%;max-width:720px;background:linear-gradient(90deg,rgba(3,7,18,0.9),rgba(6,8,20,0.9));padding:10px;border-radius:14px;margin:0 18px;display:flex;justify-content:space-around;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    .nav-btn{background:transparent;border:none;color:var(--muted);display:flex;flex-direction:column;align-items:center;gap:6px;font-size:13px;cursor:pointer}
    .nav-btn .dot{width:10px;height:10px;border-radius:50%;background:transparent}
    .nav-btn.active{color:var(--accent)}
    .nav-btn svg{opacity:0.9}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Carlitos — Prototipo MVP</h1>
      <div class="mini small">Data guardada en tu navegador • Versión prototipo</div>
    </header>

    <div class="grid">
      <!-- Left: Main -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;gap:12px;align-items:center">
            <div>
              <div class="small">Balance estimado (mes)</div>
              <div id="ifp" style="font-size:22px;font-weight:700">S/ 0</div>
              <div class="hint">PIB personal (IFP) = Ingresos − Gastos</div>
            </div>
            <div style="width:45%">
              <div class="small">Pronóstico gasto (30 días)</div>
              <canvas id="forecastChart" height="80"></canvas>
            </div>
          </div>
          <hr style="border:none;border-top:1px solid rgba(255,255,255,0.03);margin:12px 0">
          <div style="display:flex;gap:12px;align-items:center">
            <div style="flex:1">
              <div class="small">Registrar gasto / ingreso</div>
              <form id="entryForm">
                <div class="row">
                  <select id="type" required>
                    <option value="expense">Gasto</option>
                    <option value="income">Ingreso</option>
                  </select>
                  <input id="amount" type="number" step="0.01" placeholder="Monto (S/)" required>
                </div>
                <div class="row">
                  <select id="category" required>
                    <!-- Se llena dinámicamente en JS -->
                  </select>
                  <input id="date" type="date" required>
                </div>
                <div class="row">
                  <input id="note" placeholder="Nota (opcional)">
                  <button type="submit">Registrar</button>
                </div>
              </form>
            </div>
            <div style="width:220px">
              <div class="small">Indicadores rápidos</div>
              <div class="kpis">
                <div class="kpi"><div class="small">Ingreso mensual</div><div id="sumIncome" style="font-weight:700">S/0</div></div>
                <div class="kpi"><div class="small">Gasto mensual</div><div id="sumExpense" style="font-weight:700">S/0</div></div>
                <div class="kpi"><div class="small">Salud sistema</div><div id="health" style="font-weight:700">0/100</div></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Entries list -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Movimientos recientes</strong> <span class="small">(últimos 30)</span></div>
            <div class="flex">
              <button id="clearBtn" class="btn-ghost">Limpiar datos</button>
              <button id="seedBtn" class="btn-ghost">Cargar ejemplo</button>
            </div>
          </div>
          <div id="entriesList" style="margin-top:10px;max-height:320px;overflow:auto"></div>
        </div>

        <!-- Levels / Missions -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Camino Carlitos</strong><div class="small">Niveles y micro-lecciones</div></div>
            <div id="levelBadge" class="level">Nivel 0 • Comienza</div>
          </div>

          <div id="lessonBox" style="margin-top:10px">
            <div class="small">Lección actual:</div>
            <div id="lessonText" style="margin-top:8px;padding:10px;border-radius:8px;background:rgba(255,255,255,0.02)">
              Registra tus primeros 3 movimientos para desbloquear la lección 1.
            </div>
            <div style="margin-top:8px" id="lessonAction"></div>
          </div>
        </div>

      </div>

      <!-- Right: Charts & tips -->
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Distribución por categoría</strong></div>
            <div class="small">Insight rápido</div>
          </div>
          <canvas id="pieChart" height="200" style="margin-top:12px"></canvas>
          <div id="insight" class="hint" style="margin-top:10px">Registra movimientos para obtener recomendaciones.</div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Gasto diario (últimos 30 días)</strong></div>
            <div class="small">Tendencia</div>
          </div>
          <canvas id="lineChart" height="160" style="margin-top:12px"></canvas>
        </div>

        <div class="card" style="margin-top:12px">
          <div><strong>Sugerencias rápidas</strong></div>
          <ul id="suggestions" style="margin-top:8px"></ul>
        </div>

      </div>
    </div>

    <footer class="small">Prototipo MVP • Carlitos — Enseña principios y deja crear tu propio sistema</footer>
  </div>

  <!-- Bottom nav -->
  <div class="bottom-nav" role="navigation" aria-label="Navegación principal">
    <div class="nav-inner">
      <a class="nav-btn active" href="index.html" id="nav-home">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 11.5L12 4l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-8.5z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Home
      </a>
      <a class="nav-btn" href="microaprendizaje.html" id="nav-micro">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Microaprendizaje
      </a>
      <a class="nav-btn" href="camino.html" id="nav-camino">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 12h18M8 6h8M10 18h4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/></svg>
        Camino
      </a>
    </div>
  </div>

<script>
/* -----------------------
  Modelo de datos en localStorage:
  'carlitos_entries_v1' => array de {id, type: 'expense'|'income', amount, category, date, note}
-------------------------*/

const STORAGE_KEY = 'carlitos_entries_v1';
const form = document.getElementById('entryForm');
const entriesList = document.getElementById('entriesList');
const sumIncomeEl = document.getElementById('sumIncome');
const sumExpenseEl = document.getElementById('sumExpense');
const ifpEl = document.getElementById('ifp');
const healthEl = document.getElementById('health');
const pieCtx = document.getElementById('pieChart').getContext('2d');
const lineCtx = document.getElementById('lineChart').getContext('2d');
const forecastCtx = document.getElementById('forecastChart').getContext('2d');
const lessonText = document.getElementById('lessonText');
const lessonAction = document.getElementById('lessonAction');
const levelBadge = document.getElementById('levelBadge');
const suggestionsEl = document.getElementById('suggestions');
const insightEl = document.getElementById('insight');
const typeSelect = document.getElementById('type');
const categorySelect = document.getElementById('category');

let entries = loadEntries();
let pieChart, lineChart, forecastChart;

/* Categorías por tipo */
const CATS = {
  expense: ['Alimentación','Transporte','Ocio','Salud','Educación','Otros'],
  income: ['Sueldo','Trabajo freelance','Beca','Regalo','Otros ingresos']
};

function populateCategory(type){
  categorySelect.innerHTML = '';
  CATS[type].forEach(c=>{
    const opt = document.createElement('option');
    opt.value = c;
    opt.textContent = c;
    categorySelect.appendChild(opt);
  });
}

/* inicializar select según tipo por defecto */
populateCategory(typeSelect.value);

typeSelect.addEventListener('change', (e)=>{
  populateCategory(e.target.value);
});

function loadEntries(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return [];
  try { return JSON.parse(raw) } catch(e){ return [] }
}

function saveEntries(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));
}

function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6) }

function addEntry(e){
  e.preventDefault();
  const type = document.getElementById('type').value;
  const amount = parseFloat(document.getElementById('amount').value);
  const category = document.getElementById('category').value;
  const date = document.getElementById('date').value;
  const note = document.getElementById('note').value || '';
  if(!date || !amount) return alert('Completa monto y fecha');

  entries.push({id:uid(), type, amount, category, date, note});
  saveEntries();
  form.reset();
  populateCategory('expense'); // reset category to expenses default
  typeSelect.value = 'expense';
  renderAll();
}

form.addEventListener('submit', addEntry);

// seed example
document.getElementById('seedBtn').addEventListener('click', ()=>{
  entries = [
    {id:uid(),type:'income',amount:2000,category:'Sueldo',date:todayPlus(-7),note:'Sueldo mensual'},
    {id:uid(),type:'expense',amount:25,category:'Alimentación',date:todayPlus(-6),note:'Desayuno'},
    {id:uid(),type:'expense',amount:40,category:'Transporte',date:todayPlus(-6),note:'Taxi'},
    {id:uid(),type:'expense',amount:120,category:'Ocio',date:todayPlus(-5),note:'Cena'},
    {id:uid(),type:'expense',amount:50,category:'Alimentación',date:todayPlus(-4),note:'Almuerzo'},
    {id:uid(),type:'expense',amount:80,category:'Educación',date:todayPlus(-3),note:'Curso'},
    {id:uid(),type:'expense',amount:400,category:'Otros',date:todayPlus(-2),note:'Pago tarjeta'},
    {id:uid(),type:'income',amount:300,category:'Trabajo freelance',date:todayPlus(-1),note:'Proyecto pequeño'}
  ];
  saveEntries(); renderAll();
});
document.getElementById('clearBtn').addEventListener('click', ()=>{
  if(confirm('Borrar todos los datos locales?')){ entries=[]; saveEntries(); renderAll(); }
});

function todayPlus(offsetDays=0){
  const d = new Date();
  d.setDate(d.getDate()+offsetDays);
  return d.toISOString().slice(0,10);
}

/* ---------- Render ---------- */
function renderAll(){
  renderList();
  updateKPIs();
  renderCharts();
  updateLessons();
  updateSuggestions();
}

function renderList(){
  entriesList.innerHTML = '';
  const latest = entries.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).slice(0,30);
  if(latest.length===0){ entriesList.innerHTML = '<div class="small">Sin movimientos aún</div>'; return; }
  latest.forEach(item=>{
    const div = document.createElement('div');
    div.className='entry';
    const left = document.createElement('div');
    left.innerHTML = `<div><strong>${item.category}</strong> <span class="small"> · ${item.date}</span></div>
                      <div class="small">${item.note || ''}</div>`;
    const right = document.createElement('div');
    const sign = item.type==='expense' ? '-' : '+';
    right.innerHTML = `<div style="text-align:right"><span class="${item.type==='expense'?'danger':'ok'}">${sign} S/ ${item.amount.toFixed(2)}</span></div>
                       <div style="text-align:right"><button class="btn-ghost" onclick="deleteEntry('${item.id}')">Eliminar</button></div>`;
    div.appendChild(left); div.appendChild(right);
    entriesList.appendChild(div);
  });
}

function deleteEntry(id){
  if(!confirm('Eliminar movimiento?')) return;
  entries = entries.filter(e=>e.id!==id);
  saveEntries(); renderAll();
}

/* ---------- KPIs and simple forecast ---------- */
function updateKPIs(){
  const incomes = entries.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const expenses = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  sumIncomeEl.textContent = `S/ ${incomes.toFixed(2)}`;
  sumExpenseEl.textContent = `S/ ${expenses.toFixed(2)}`;
  const ifp = incomes - expenses;
  ifpEl.textContent = `S/ ${ifp.toFixed(2)}`;

  // health score simple: baseline 100 minus normalized expense/income ratio
  let health = 50;
  if(incomes>0){
    const ratio = expenses / incomes;
    health = Math.max(10, Math.round(100 - ratio*100));
  } else {
    health = expenses===0 ? 100 : 10;
  }
  healthEl.textContent = `${health}/100`;

  // forecast: promedio diario * días en mes left
  const daily = avgDailyExpense();
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
  const remaining = Math.max(0, daysInMonth - today.getDate());
  const proj = (daily * daysInMonth);
  // show on forecast chart later
  renderForecastChart(proj, daily);
}

/* average daily expense over last 30 days */
function avgDailyExpense(){
  const now = new Date();
  const past30 = new Date(); past30.setDate(now.getDate()-29);
  const filtered = entries.filter(e=>{
    if(e.type!=='expense') return false;
    const d = new Date(e.date);
    return d>=past30 && d<=now;
  });
  const total = filtered.reduce((s,e)=>s+e.amount,0);
  return filtered.length>0 ? total/30 : 0;
}

/* ---------- Charts ---------- */
function renderCharts(){
  // Pie by category (only expenses)
  const expenses = entries.filter(e=>e.type==='expense');
  const byCat = {};
  expenses.forEach(e=> byCat[e.category] = (byCat[e.category]||0)+e.amount);
  const labels = Object.keys(byCat);
  const data = labels.map(l=> byCat[l]);
  if(pieChart) pieChart.destroy();
  pieChart = new Chart(pieCtx, {
    type:'doughnut',
    data:{labels, datasets:[{data, backgroundColor:generateColors(labels.length)}]},
    options:{plugins:{legend:{display:true,position:'bottom'},tooltip:{mode:'index'}}}
  });

  // Line chart daily expenses last 30 days
  const days = [];
  const amounts = [];
  for(let i=29;i>=0;i--){
    const d = new Date(); d.setDate(d.getDate()-i);
    const key = d.toISOString().slice(0,10);
    days.push(key);
    const sum = entries.filter(en=>en.type==='expense' && en.date===key).reduce((s,e)=>s+e.amount,0);
    amounts.push(sum);
  }
  if(lineChart) lineChart.destroy();
  lineChart = new Chart(lineCtx, {
    type:'line',
    data:{labels:days, datasets:[{label:'Gasto diario (S/)', data:amounts, fill:true, tension:0.25}]},
    options:{scales:{x:{display:false}}}
  });
}

function renderForecastChart(proj, daily){
  if(forecastChart) forecastChart.destroy();
  forecastChart = new Chart(forecastCtx, {
    type:'bar',
    data:{labels:['Proy mes'], datasets:[{label:'Gasto proyectado S/',data:[proj],barThickness:30}]},
    options:{plugins:{legend:{display:false},tooltip:{enabled:true}}}
  });
  // small insight
  document.getElementById('forecastChart').style.maxWidth='100%';
}

/* ---------- Small recommender and lessons ---------- */
function updateLessons(){
  const count = entries.length;
  let level = 0;
  if(count>=15) level = 3;
  else if(count>=7) level = 2;
  else if(count>=3) level = 1;

  levelBadge.textContent = `Nivel ${level} • ${levelName(level)}`;
  // lesson content
  if(level===0){
    lessonText.textContent = 'Registra tus primeros 3 movimientos para desbloquear la lección 1: "Ahorra primero".';
    lessonAction.innerHTML = '';
  } else if(level===1){
    lessonText.innerHTML = 'Lección 1 — Principio: <strong>Ahorra primero</strong>. Acción sugerida: aparta S/ 10 semanales. <div class="small hint">Empieza con poco: lo importante es hábito.</div>';
    lessonAction.innerHTML = `<button class="btn-ghost" onclick="applyRule('savings_small')">Simular activar ahorro S/10 sem/ (probar)</button>`;
  } else if(level===2){
    lessonText.innerHTML = 'Lección 2 — Principio: <strong>Presupuestar por categorías</strong>. Acción: define top 3 categorías y establece límites semanales.';
    lessonAction.innerHTML = `<button class="btn-ghost" onclick="applyRule('budget_top3')">Simular regla presupuesto</button>`;
  } else {
    lessonText.innerHTML = 'Lección 3 — Principio: <strong>Atacar deudas</strong>. Acción: prueba plan "bola de nieve" para pagar tarjeta más rápido.';
    lessonAction.innerHTML = `<button class="btn-ghost" onclick="applyRule('debt_avalanche')">Simular plan deuda</button>`;
  }
}

function levelName(l){
  return ['Comienza','Ahorro','Control','Deuda'][l]||'Comienza';
}

function applyRule(key){
  // Simulamos una regla: esto no mueve dinero real, solo demuestra la acción integrada.
  if(key==='savings_small'){
    alert('Regla simulada: apartar S/10 semanal. Se aplicará como sugerencia en el panel.');
    localStorage.setItem('carlitos_rule_savings','active');
  } else if(key==='budget_top3'){
    alert('Regla simulada: top3 categorías con límites semanales. Verás alertas cuando te acerques al límite.');
    localStorage.setItem('carlitos_rule_budget','active');
  } else if(key==='debt_avalanche'){
    alert('Regla simulada: plan bola de nieve activado (simulación).');
    localStorage.setItem('carlitos_rule_debt','active');
  }
  renderAll();
}

/* suggestions based on simple heuristics */
function updateSuggestions(){
  suggestionsEl.innerHTML = '';
  insightEl.textContent = '';
  const incomes = entries.filter(e=>e.type==='income').reduce((s,e)=>s+e.amount,0);
  const expenses = entries.filter(e=>e.type==='expense').reduce((s,e)=>s+e.amount,0);
  if(incomes>0){
    const ratio = expenses / incomes;
    if(ratio>0.6){
      pushSuggestion('Estás gastando más del 60% de tus ingresos. Principio: prioriza necesidades. ¿Quieres empezar con la lección "Ahorra primero"?');
      insightEl.textContent = 'Sugerencia: Prueba reducir ocio o delivery 30% por 7 días.';
    } else if(ratio<0.25){
      pushSuggestion('Buen manejo: tus gastos son bajos respecto a ingresos. Principio: invierte en I (tu educación/activo)');
      insightEl.textContent = 'Sugerencia: Considera destinar un % pequeño a cursos o herramienta que aumenten ingresos.';
    } else {
      pushSuggestion('Balance estable. Principio: mantén hábitos, revisa monthly. Desbloquea misiones para mejorar.');
      insightEl.textContent = 'Sugerencia: desbloquea lecciones del Camino Carlitos.';
    }
  } else {
    pushSuggestion('Aún no registras ingresos. Si eres estudiante, registra al menos un ingreso (aunque sea pequeño) para poder calcular ratios.');
  }
  // show applied rules
  if(localStorage.getItem('carlitos_rule_savings')) pushSuggestion('Regla activa (simulación): Ahorro semanal S/10');
  if(localStorage.getItem('carlitos_rule_budget')) pushSuggestion('Regla activa (simulación): Presupuesto top3');
  if(localStorage.getItem('carlitos_rule_debt')) pushSuggestion('Regla activa (simulación): Plan deuda activo');

  function pushSuggestion(text){
    const li = document.createElement('li');
    li.innerHTML = `<div class="small">${text}</div>`;
    suggestionsEl.appendChild(li);
  }
}

/* ---------- Utils ---------- */
function generateColors(n){
  const palette = ['#06b6d4','#7dd3fc','#60a5fa','#f97316','#f43f5e','#34d399','#a78bfa','#f59e0b'];
  const out=[];
  for(let i=0;i<n;i++) out.push(palette[i%palette.length]);
  return out;
}

/* ---------- initial render ---------- */
renderAll();

</script>
</body>
</html>
